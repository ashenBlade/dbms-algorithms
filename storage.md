# Движок хранения

Движок хранения - это компонент ответственный за хранение страниц файлов.

Проблем несколько:

1. База данных может занимать гораздо больше места, чем доступно оперативной памяти
2. При операциях с файлами (персистентным хранилищем) необходимо соблюдать атомарность

Обе эти задачи решаются с помощью движка хранения. В общем он состоит из нескольких компонентов:

- Пул буферов - хранит выделенную память под прочитанные с диска страницы. Обычно занимает в СУБД большую часть памяти
- Алгоритм вытеснения страниц - когда доступных буферов становится недостаточно, то некоторые из страниц придется вытеснить (сбросить обратно на диск), - этот компонент говорит нам о том, какую страницу надо сбросить следующей
- IO планировщик - определяет какие IO операции выполнять следующими. Дисковая система ОС имеет свой кэш страниц и планировщик, но СУБД лучше знает о паттернах работы с диском, поэтому ей лучше знать как перераспределить дисковые операции для большей производительности.

## PostgreSQL

## MySQL

Имеет подключаемые движки хранения, где каждый имеет свой формат файлов.

Примеры:

- InnoDB - (по умолчанию) ACID 
- MyISAM - 
- Memory - in memory
- CSV
- Archive
- Blackhole
- Merge
- Federated
- Example

### Buffer pool

Пул состоит из нескольких инстансов пула (`innodb_buffer_pool_instances=XXX`), где каждый имеет свои наборы блокировок, списков свободных страниц и т.д., что уменьшает количество конфликтов блокировок.

Каждый инстанс организован как связный список фреймов (страниц). Сам список - это LRU список, т.е. страницы в нем располагаются для удобства вытеснения.

Каждый фрейм имеет свой тип: Data, Index, System, Change, Adaptive, Lock.

Имеется несколько дополнительных структур:

- Page table - отображение страницы на фрейм
- LRU - список для вытеснения
- Free - список свободных страниц
- Flush - список грязных фреймов для записи на диск

### Eviction

Используется модифицированный LRU алгоритм.

Идея модификации в том, чтобы не отслеживать страницы, которые были использованы единожды во время SeqScan.

Весь список делится на 2 части:

1. Young
2. Old

Когда страница добавляется, то она вставляется *по середине*, а не в конец. Таким образом, если мы прочитали страницу, а затем потребовалось место для новой, то вытеснена будет какая-то другая страница, в конце списка, а не наша новая.

### IO Scheduler

Не имеет

## SQL Server

### Buffer pool

Сам сервер автоматически выделяет память по необходимости, т.е. размер пула саморегулируется.

### Eviction

Используется LRU-2
